<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Smart Vehicle System</title>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    * { font-family: Segoe UI, system-ui, sans-serif; box-sizing: border-box; }
    body { margin: 0; background: #e5e7eb; }
    body.dark { background: #020617; }

    .app { display: flex; height: 100vh; }

    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, #020617, #020617dd);
      color: white;
      padding: 10px;
      display: flex;
      flex-direction: column;
    }

    .sidebar-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .brand { font-size: 16px; font-weight: 600; }
    .actions { display: flex; gap: 8px; }

    .icon-btn {
      background: #2563eb;
      border: none;
      color: white;
      border-radius: 0;
      padding: 8px;
      font-size: 18px;
      cursor: pointer;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .dark-btn { background: #0f172a; }

    .menu-item {
      padding: 10px 12px;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 6px;
      font-size: 14px;
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .menu-item:hover,
    .menu-item.active { background: rgba(255,255,255,0.15); }
    .menu-item.danger { background: rgba(239,68,68,0.25); }

    .main {
      flex: 1;
      background: linear-gradient(120deg, #f1f5ff, #fefce8);
      padding: 20px;
      overflow-y: auto;
    }

    body.dark .main { background: #020617; color: white; }

    .card {
      background: white;
      border-radius: 14px;
      padding: 20px;
      box-shadow: 0 6px 15px rgba(0,0,0,0.15);
      max-width: 1150px;
    }

    body.dark .card { background: #0f172a; color: white; }

    input, select, button {
      padding: 10px 14px;
      margin: 6px 0;
      width: 280px;
      border-radius: 8px;
      border: 1px solid #cbd5e1;
      font-size: 14px;
    }

    button {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: white;
      border: none;
      cursor: pointer;
    }

    #slots {
      margin: 15px 0;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
      gap: 8px;
      max-width: 350px;
    }

    .slot {
      width: 50px;
      height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 10px;
      font-weight: bold;
      color: white;
    }

    .free { background: #22c55e; }
    .busy { background: #ef4444; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    th { background: #1e293b; color: white; padding: 10px; }
    td { background: #f8fafc; padding: 8px; text-align: center; }
    tr:nth-child(even) td { background: #eef2ff; }
    body.dark td { background: #020617; color: white; }

    .infoBox {
      background: #e0f2fe;
      padding: 14px;
      border-radius: 12px;
      margin-top: 10px;
    }

    .summaryBox {
      background: #dcfce7;
      padding: 14px;
      border-radius: 12px;
      margin-top: 10px;
      font-weight: bold;
    }

    .deleteBtn {
      background: #ef4444;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 6px;
      cursor: pointer;
    }

    section { display: none; }
    section.active { display: block; }

    /* Scanner HARD stable UI */
    #readerWrapper {
      width: 260px;
      height: 260px;
      margin: 10px auto;
      border-radius: 12px;
      overflow: hidden;
      background: #000;
    }

    #reader {
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
<div class="app">
  <aside class="sidebar">
    <div class="sidebar-top">
      <div class="brand">üöò Smart Vehicle</div>
      <div class="actions">
        <button class="icon-btn dark-btn" onclick="toggleTheme()">üåô</button>
      </div>
    </div>

    <div class="menu-item active" onclick="show('dashboard',this)">üè† Dashboard</div>
    <div class="menu-item" onclick="show('booking',this)">üÖø Booking</div>
    <div class="menu-item" onclick="show('scanner',this)">üì∑ QR Scan</div>
    <div class="menu-item" onclick="show('history',this)">üìú History</div>
    <div class="menu-item danger" onclick="clearAll()">üóë Clear All</div>
  </aside>

  <main class="main">
    <h2 id="pageTitle">Dashboard</h2>

    <section id="dashboard" class="active">
      <div class="card">
        <h3>Parking Slots</h3>
        <div id="slots"></div>

        <h3>Live Parking Logs</h3>
        <table>
          <tr>
            <th>Name</th><th>Vehicle</th><th>Slot</th>
            <th>Entry</th><th>Exit</th><th>Payment</th>
            <th>Amount</th><th>Status</th>
          </tr>
          <tbody id="logs"></tbody>
        </table>
      </div>
    </section>

    <section id="booking">
      <div class="card">
        <h3>Book Parking</h3>
        <input id="name" placeholder="Owner Name">
        <input id="mobile" placeholder="Mobile Number">
        <input id="vehicle" placeholder="Vehicle Number">
        <select id="slotSelect"></select>
        <select id="payment">
          <option value="">Select Payment</option>
          <option>UPI</option>
          <option>Net Banking</option>
          <option>Cash</option>
        </select>
        <button onclick="book()">Generate QR</button>
        <div id="qrBox"></div>
        <button onclick="downloadPDF()">üìÑ Download Ticket</button>
      </div>
    </section>

    <section id="scanner">
      <div class="card">
        <h3>QR Scan</h3>
        <div id="readerWrapper">
          <div id="reader"></div>
        </div>
        <div id="scanInfo"></div>
      </div>
    </section>

    <section id="history">
      <div class="card">
        <h3>Vehicle History</h3>
        <input id="searchVehicle" placeholder="Enter Vehicle Number">
        <button onclick="searchHistory()">Search</button>
        <button onclick="deleteVehicleHistory()">Delete History</button>
        <div id="historySummary"></div>
        <table>
          <tr>
            <th>#</th><th>Name</th><th>Mobile</th>
            <th>Entry</th><th>Exit</th><th>Payment</th>
            <th>Amount</th><th>Delete</th>
          </tr>
          <tbody id="historyResults"></tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<script>
const { jsPDF } = window.jspdf;

let slots = Array(25).fill(0);
let logs = [];
let qrScanner = null;
let lastBooking = null;
let scanLock = false;

const RATE_PER_HOUR = 20;

const name = document.getElementById("name");
const mobile = document.getElementById("mobile");
const vehicle = document.getElementById("vehicle");
const slotSelect = document.getElementById("slotSelect");
const payment = document.getElementById("payment");
const qrBox = document.getElementById("qrBox");
const scanInfo = document.getElementById("scanInfo");
const slotsDiv = document.getElementById("slots");
const logsBody = document.getElementById("logs");

const searchVehicle = document.getElementById("searchVehicle");
const historyResults = document.getElementById("historyResults");
const historySummary = document.getElementById("historySummary");

function toggleTheme() { document.body.classList.toggle("dark"); }

function show(id, el) {
  document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");

  document.querySelectorAll(".menu-item").forEach(m => m.classList.remove("active"));
  if (el) el.classList.add("active");

  let titles = { dashboard:"Dashboard", booking:"Booking", scanner:"QR Scan", history:"History" };
  pageTitle.innerText = titles[id];

  if (id === "scanner") {
    setTimeout(forceRestartScanner, 300);
  } else {
    stopScanner();
  }
}

function stopScanner() {
  if (qrScanner) {
    qrScanner.stop().catch(()=>{});
    qrScanner = null;
  }
}

function forceRestartScanner() {
  stopScanner();

  const wrap = document.getElementById("readerWrapper");
  wrap.innerHTML = '<div id="reader"></div>';

  scanInfo.innerHTML = "";

  qrScanner = new Html5Qrcode("reader");
  qrScanner.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 180 },
    onScanSuccess,
    (err) => {}
  ).catch(err => {
    scanInfo.innerHTML = "‚ùå Camera error / permission denied";
  });
}

function onScanSuccess(text) {
  if (scanLock) return;
  scanLock = true;

  let log = logs.find(l => l.qr === text);
  if (!log) {
    scanInfo.innerHTML = "‚ùå Invalid QR";
    setTimeout(()=>scanLock=false, 1500);
    return;
  }

  let now = new Date();
  let amount = calculateAmount(log.entryTime, now);

  if (log.status === "IN") {
    log.status = "EXIT_PENDING";
    scanInfo.innerHTML = infoHTML("ENTRY CONFIRMED", log, amount);
  }
  else if (log.status === "EXIT_PENDING") {
    log.status = "OUT";
    log.exitTime = now;
    log.amount = amount;
    slots[log.slot - 1] = 0;
    scanInfo.innerHTML = infoHTML("EXIT SUCCESSFUL", log, amount);
  }
  else {
    scanInfo.innerHTML = "‚ùå Already exited";
  }

  saveData();
  renderSlots();
  renderLogs();

  setTimeout(() => {
    scanInfo.innerHTML += "<br><b>Ready for next scan...</b>";
    scanLock = false;
  }, 2000);
}

function saveData() {
  localStorage.setItem("parking_slots", JSON.stringify(slots));
  localStorage.setItem("parking_logs", JSON.stringify(logs));
}

function loadData() {
  let s = localStorage.getItem("parking_slots");
  let l = localStorage.getItem("parking_logs");
  if (s) slots = JSON.parse(s);
  if (l) logs = JSON.parse(l);
}
loadData();

function renderSlots() {
  slotsDiv.innerHTML = slots.map((s,i)=>
    `<div class="slot ${s?'busy':'free'}">${i+1}</div>`).join("");
  slotSelect.innerHTML = slots.map((s,i)=>!s?
    `<option value="${i}">Slot ${i+1}</option>`:"").join("");
}

function renderLogs() {
  logsBody.innerHTML = logs.map(l=>`<tr>
    <td>${l.name}</td><td>${l.vehicle}</td><td>${l.slot}</td>
    <td>${new Date(l.entryTime).toLocaleString()}</td>
    <td>${l.exitTime?new Date(l.exitTime).toLocaleString():"-"}</td>
    <td>${l.payment}</td><td>${l.amount??"-"}</td>
    <td>${l.status}</td>
  </tr>`).join("");
}

function book() {
  if (!name.value || !mobile.value || !vehicle.value || !payment.value) {
    alert("All fields required"); return;
  }

  let s = slotSelect.value;
  slots[s] = 1;

  let entry = new Date();
  let qrData = vehicle.value + "|" + entry.getTime();

  let newLog = {
    name:name.value, mobile:mobile.value, vehicle:vehicle.value,
    slot:Number(s)+1, entryTime:entry, exitTime:null,
    payment:payment.value, amount:null, status:"IN", qr:qrData
  };

  logs.push(newLog);
  lastBooking = newLog;

  qrBox.innerHTML = "";
  new QRCode(qrBox,{ text:qrData, width:180, height:180 });

  saveData(); renderSlots(); renderLogs();

  name.value=""; mobile.value=""; vehicle.value=""; payment.value="";
  alert("Booking Successful!");
}

function calculateAmount(entryTime, exitTime) {
  let hours = Math.ceil((exitTime - new Date(entryTime))/(1000*60*60));
  return Math.max(1,hours)*RATE_PER_HOUR;
}

function infoHTML(title, log, amount) {
  return `<div class="infoBox">
    <b>${title}</b><br>
    Vehicle: ${log.vehicle}<br>
    Slot: ${log.slot}<br>
    Amount: ‚Çπ${amount}
  </div>`;
}

function searchHistory() {
  let v = searchVehicle.value.trim().toLowerCase();
  historyResults.innerHTML="";
  historySummary.innerHTML="";

  if (!v) { historySummary.innerHTML="Enter vehicle number!"; return; }

  let matches = logs.map((l,i)=>({...l,_index:i}))
                    .filter(l=>l.vehicle.toLowerCase()===v);

  if (!matches.length) { historySummary.innerHTML="No history found"; return; }

  let total=0;
  matches.forEach((l,i)=>{
    total+=l.amount||0;
    historyResults.innerHTML+=`<tr>
      <td>${i+1}</td><td>${l.name}</td><td>${l.mobile}</td>
      <td>${new Date(l.entryTime).toLocaleString()}</td>
      <td>${l.exitTime?new Date(l.exitTime).toLocaleString():"-"}</td>
      <td>${l.payment}</td><td>${l.amount||0}</td>
      <td><button class="deleteBtn" onclick="deleteOne(${l._index})">X</button></td>
    </tr>`;
  });

  historySummary.innerHTML=`<div class="summaryBox">
    Visits: ${matches.length} | Total: ‚Çπ${total}
  </div>`;
}

function deleteOne(i) {
  if (!confirm("Delete this record?")) return;
  logs.splice(i,1);
  saveData(); searchHistory(); renderLogs();
}

function deleteVehicleHistory() {
  let v = searchVehicle.value.trim().toLowerCase();
  if (!v) { alert("Enter vehicle number"); return; }

  logs = logs.filter(l=>l.vehicle.toLowerCase()!==v);
  saveData(); searchHistory(); renderLogs();
}

function clearAll() {
  if (!confirm("Delete all data?")) return;
  slots = Array(25).fill(0);
  logs = [];
  lastBooking = null;

  localStorage.removeItem("parking_slots");
  localStorage.removeItem("parking_logs");

  qrBox.innerHTML="";
  scanInfo.innerHTML="";
  historyResults.innerHTML="";
  historySummary.innerHTML="";
  slotSelect.innerHTML="";

  renderSlots(); renderLogs();
  alert("‚úÖ All data cleared successfully!");
}

function downloadPDF() {
  if (!lastBooking) { alert("No booking found!"); return; }

  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text("SMART PARKING TICKET",20,20);

  doc.setFontSize(12);
  doc.text("Name: "+lastBooking.name,20,40);
  doc.text("Mobile: "+lastBooking.mobile,20,50);
  doc.text("Vehicle: "+lastBooking.vehicle,20,60);
  doc.text("Slot: "+lastBooking.slot,20,70);
  doc.text("Entry: "+new Date(lastBooking.entryTime).toLocaleString(),20,80);
  doc.text("Payment: "+lastBooking.payment,20,90);

  let qrCanvas = qrBox.querySelector("canvas");
  if (qrCanvas) {
    let qrImg = qrCanvas.toDataURL("image/png");
    doc.text("Scan QR Code:",20,110);
    doc.addImage(qrImg,"PNG",20,120,60,60);
  }

  doc.save("ticket_"+lastBooking.vehicle+".pdf");
}

renderSlots();
renderLogs();
</script>
</body>
</html>
