<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Smart Parking System</title>

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        * {
            font-family: Segoe UI, Arial;
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: #f3f4f6
        }

        header {
            background: #0f172a;
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        header button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 5px;
            margin-left: 5px;
            cursor: pointer
        }

        section {
            display: none;
            padding: 20px
        }

        section.active {
            display: block
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, .1)
        }

        .slot {
            width: 42px;
            height: 42px;
            margin: 3px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            color: white;
            font-weight: bold
        }

        .free {
            background: #16a34a
        }

        .busy {
            background: #dc2626
        }

        input,
        select,
        button {
            padding: 8px;
            margin: 5px;
            width: 260px
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: center
        }

        #reader {
            width: 300px;
            margin: auto
        }

        .infoBox {
            background: #eef2ff;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px
        }

        .summaryBox {
            background: #dcfce7;
            padding: 12px;
            border-radius: 8px;
            margin-top: 10px
        }

        .deleteBtn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer
        }
    </style>
</head>

<body>

    <header>
        <h3>ðŸš— Smart Parking System</h3>
        <div>
            <button onclick="show('dashboard')">Dashboard</button>
            <button onclick="show('booking')">Booking</button>
            <button onclick="show('scanner')">QR Scan</button>
            <button onclick="show('history')">History</button>
            <button onclick="clearAll()">Clear All</button>
        </div>
    </header>

    <!-- DASHBOARD -->
    <section id="dashboard" class="active">
        <div class="card">
            <h3>Parking Slots (25)</h3>
            <div id="slots"></div>

            <h3>Live Parking Logs</h3>
            <table>
                <tr>
                    <th>Name</th>
                    <th>Vehicle</th>
                    <th>Slot</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>Payment</th>
                    <th>Amount</th>
                    <th>Status</th>
                </tr>
                <tbody id="logs"></tbody>
            </table>
        </div>
    </section>

    <!-- BOOKING -->
    <section id="booking">
        <div class="card">
            <h3>Book Parking</h3>

            <input id="name" placeholder="Owner Name">
            <input id="mobile" placeholder="Mobile Number">
            <input id="vehicle" placeholder="Vehicle Number">

            <select id="slotSelect"></select>

            <select id="payment">
                <option value="">Select Payment</option>
                <option>UPI</option>
                <option>Net Banking</option>
                <option>Cash</option>
            </select>

            <button onclick="book()">Generate QR</button>

            <div id="qrBox"></div>
            <button onclick="downloadPDF()">ðŸ“„ Download PDF Ticket</button>

        </div>
    </section>

    <!-- QR SCAN -->
    <section id="scanner">
        <div class="card">
            <h3>QR Scan (Entry / Exit)</h3>
            <div id="reader"></div>
            <div id="scanInfo"></div>
        </div>
    </section>

    <!-- HISTORY -->
    <section id="history">
        <div class="card">
            <h3>Vehicle Booking History</h3>

            <input id="searchVehicle" placeholder="Enter Vehicle Number">
            <button onclick="searchHistory()">Search</button>
            <button onclick="deleteVehicleHistory()">ðŸ—‘ Delete Vehicle History</button>

            <div id="historySummary"></div>

            <table>
                <tr>
                    <th>#</th>
                    <th>Name</th>
                    <th>Mobile</th>
                    <th>Entry</th>
                    <th>Exit</th>
                    <th>Payment</th>
                    <th>Amount</th>
                    <th>Delete</th>
                </tr>
                <tbody id="historyResults"></tbody>
            </table>
        </div>
    </section>

    <script>
        const { jsPDF } = window.jspdf;

        let slots = Array(25).fill(0);
        let logs = [];
        let qrScanner = null;
        let lastBooking = null;

        function saveData() {
            localStorage.setItem("parking_slots", JSON.stringify(slots));
            localStorage.setItem("parking_logs", JSON.stringify(logs));
        }
        function loadData() {
            let s = localStorage.getItem("parking_slots");
            let l = localStorage.getItem("parking_logs");

            if (s) slots = JSON.parse(s);
            if (l) {
                logs = JSON.parse(l);
                logs.forEach(log => {
                    log.entryTime = new Date(log.entryTime);
                    if (log.exitTime) log.exitTime = new Date(log.exitTime);
                });
            }
        }
        loadData();

        function show(id) {
            document.querySelectorAll("section").forEach(s => s.classList.remove("active"));
            document.getElementById(id).classList.add("active");
            renderSlots(); renderLogs();
            if (id === "scanner") startScanner();
        }

        function renderSlots() {
            let html = "";
            slots.forEach((s, i) => {
                html += `<div class="slot ${s ? 'busy' : 'free'}">${i + 1}</div>`;
            });
            slotsDiv.innerHTML = html;

            let opt = "";
            slots.forEach((s, i) => {
                if (!s) opt += `<option value="${i}">Slot ${i + 1}</option>`;
            });
            slotSelect.innerHTML = opt;
        }

        function renderLogs() {
            let html = "";
            logs.forEach(l => {
                html += `<tr>
<td>${l.name}</td>
<td>${l.vehicle}</td>
<td>${l.slot}</td>
<td>${l.entryTime.toLocaleString()}</td>
<td>${l.exitTime ? l.exitTime.toLocaleString() : "-"}</td>
<td>${l.payment}</td>
<td>${l.amount ?? "-"}</td>
<td>${l.status}</td>
</tr>`;
            });
            logsBody.innerHTML = html;
        }

        function book() {
            if (!name.value || !mobile.value || !vehicle.value || !payment.value) {
                alert("All fields required"); return;
            }

            let s = slotSelect.value;
            if (slots[s] === 1) { alert("Slot already booked"); return; }

            slots[s] = 1;
            let entry = new Date();
            let qrData = vehicle.value + "|" + entry.getTime();

            let newLog = {
                name: name.value,
                mobile: mobile.value,
                vehicle: vehicle.value,
                slot: Number(s) + 1,
                entryTime: entry,
                exitTime: null,
                payment: payment.value,
                amount: null,
                status: "IN",
                qr: qrData
            };

            logs.push(newLog);
            lastBooking = newLog;

            qrBox.innerHTML = "";
            new QRCode(qrBox, { text: qrData, width: 300, height: 300 });

            saveData();
            renderSlots(); renderLogs();
            alert("âœ… Parking Booked & QR Generated");
        }

        function downloadPDF() {
            if (!lastBooking) { alert("No booking"); return; }

            let canvas = document.querySelector("#qrBox canvas");
            let imgData = canvas.toDataURL("image/png");

            let doc = new jsPDF();
            doc.text("SMART PARKING TICKET", 20, 20);
            doc.text(`Name: ${lastBooking.name}`, 20, 35);
            doc.text(`Mobile: ${lastBooking.mobile}`, 20, 45);
            doc.text(`Vehicle: ${lastBooking.vehicle}`, 20, 55);
            doc.text(`Slot: ${lastBooking.slot}`, 20, 65);
            doc.text(`Entry: ${lastBooking.entryTime.toLocaleString()}`, 20, 75);
            doc.addImage(imgData, "PNG", 60, 90, 90, 90);
            doc.save("parking_ticket.pdf");
        }

        function startScanner() {
            document.getElementById("reader").innerHTML = "";
            scanInfo.innerHTML = "";

            if (qrScanner) { qrScanner.stop().catch(() => { }); }

            qrScanner = new Html5Qrcode("reader");
            qrScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (text) => {
                    let log = logs.find(l => l.qr === text);
                    if (!log) { scanInfo.innerHTML = "âŒ Invalid QR"; return; }

                    let now = new Date();
                    let mins = Math.ceil((now - log.entryTime) / 60000);
                    let amount = mins > 1 ? (mins - 1) * 10 : 0;

                    if (log.status === "IN") {
                        log.status = "EXIT_PENDING";
                        scanInfo.innerHTML = infoHTML("ENTRY CONFIRMED", log, now, mins, amount);
                        saveData(); renderLogs(); return;
                    }

                    if (log.status === "EXIT_PENDING") {
                        log.status = "OUT";
                        log.exitTime = now;
                        log.amount = amount;
                        slots[log.slot - 1] = 0;

                        scanInfo.innerHTML = infoHTML("EXIT SUCCESSFUL", log, now, mins, amount);
                        saveData(); renderSlots(); renderLogs(); return;
                    }

                    scanInfo.innerHTML = "âŒ Already exited";
                },
                () => { }
            );
        }

        function infoHTML(title, log, now, mins, amount) {
            return `
<div class="infoBox">
<b>${title}</b><br>
Vehicle: ${log.vehicle}<br>
Slot: ${log.slot}<br>
Time: ${mins} min<br>
Amount: â‚¹${amount}
</div>`;
        }

        function searchHistory() {
            let v = document.getElementById("searchVehicle").value.trim().toLowerCase();
            let body = document.getElementById("historyResults");
            let summary = document.getElementById("historySummary");

            body.innerHTML = ""; summary.innerHTML = "";
            let matches = logs.filter(l => l.vehicle.toLowerCase() === v);

            if (matches.length === 0) { summary.innerHTML = "No history"; return; }

            let total = 0;
            matches.forEach((l, i) => {
                total += l.amount ?? 0;
                body.innerHTML += `<tr>
<td>${i + 1}</td>
<td>${l.name}</td>
<td>${l.mobile}</td>
<td>${l.entryTime.toLocaleString()}</td>
<td>${l.exitTime ? l.exitTime.toLocaleString() : "-"}</td>
<td>${l.payment}</td>
<td>${l.amount ?? 0}</td>
<td><button class="deleteBtn" onclick="deleteOne(${i})">X</button></td>
</tr>`;
            });

            summary.innerHTML = `<div class="summaryBox">
Visits: ${matches.length} |
Total: â‚¹${total}
</div>`;

            window.currentMatches = matches;
        }

        function deleteOne(index) {
            if (!confirm("Delete this record?")) return;

            let target = window.currentMatches[index];
            logs = logs.filter(l => l !== target);
            saveData();
            searchHistory();
            renderLogs();
        }

        function deleteVehicleHistory() {
            let v = document.getElementById("searchVehicle").value.trim().toLowerCase();
            if (v === "") { alert("Enter vehicle number"); return; }
            if (!confirm("Delete ALL history of this vehicle?")) return;

            logs = logs.filter(l => l.vehicle.toLowerCase() !== v);
            saveData();
            searchHistory();
            renderLogs();
        }

        function clearAll() {
            if (confirm("Delete all data?")) {
                localStorage.clear();
                location.reload();
            }
        }

        const name = document.getElementById("name");
        const mobile = document.getElementById("mobile");
        const vehicle = document.getElementById("vehicle");
        const slotSelect = document.getElementById("slotSelect");
        const payment = document.getElementById("payment");
        const qrBox = document.getElementById("qrBox");
        const scanInfo = document.getElementById("scanInfo");
        const slotsDiv = document.getElementById("slots");
        const logsBody = document.getElementById("logs");

        renderSlots(); renderLogs();
    </script>

</body>

</html>